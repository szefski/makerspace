  <div class="modal fade" id="terminate_membership" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Terminate membership</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form action="/member/billing" method="post">
          <div class="modal-body">
            <p>Terminating your membership fees will result in immediate revocation of access to makerspace.  Any leased lockers/storage will be cancelled and given to the next member on the waitlist.</p>
            <div class="form-group">
              <textarea class="form-control" name="cancellation_reason" rows="5" placeholder="Is there a reason for your cancellation that you would be willing to share?" autofocus></textarea>
            </div>
          </div>
          <div class="modal-footer align-items-end flex-wrap">
            <div class="mr-auto">
              <label for="password">Please verify your password:</label>
              <div class="form-inline">
                <div class="input-group">
                  <span class="input-group-addon glyphicons glyphicons-fingerprint"></span>
                  <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
                </div>
              </div>
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" name="terminate_membership" class="btn btn-danger m-0">Terminate</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
{{if not .Member.Agreed_to_terms}}
        <p class="alert alert-danger">
          Please agree to the <a href="/terms">Terms and Conditions</a> before setting up billing information.
        </p>
{{end}}
        <p class="alert alert-info">
          All prices and transactions are in Canadian dollars.<br>
          Billing inquiries should be addressed to <a href="mailto:accounting@makerspace.ca">accounting@makerspace.ca</a>.
        </p>
{{with .Member.Payment}}
        <section>
          <h4>Transactions history</h4>
          <div class="px-2 px-sm-3">
  {{with .Transactions}}
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Name</th>
                  <th>Card</th>
                </tr>
              </thead>
              <tbody>
    {{range .}}
                <tr{{if not .Approved}} title="This transaction was not approved." class="table-danger"{{end}}>
                  <td>{{.Time.Format "2006-01-02"}}</td>
                  <td>${{.Amount | printf "%.2f"}}</td>
                  <td>{{.Comment}}</td>
                  <td><small class="text-muted">x-{{.Card}}</small></td>
                  </td>
                </tr>
    {{end}}
              </tbody>
            </table>
  {{else}}
            <p>You have no recent transactions.</p>
  {{end}}
  {{with .Invoices}}
            <h5>Monthly payments</h5>
            <form action="/member/billing" method="post" id="monthly">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Start date</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
    {{range .}}
                <tr>  
                  <td>{{.Description}}</td>
                  <td>${{.Amount | printf "%.2f"}}</td>
                  <td>{{.Date.Format "2006-01-02"}}</td>
                  <td>
      {{if eq .Fee.Category "membership"}}
                    <button type="button" data-toggle="modal" data-target="#terminate_membership" class="btn btn-sm btn-danger">Terminate</button>
      {{else}}
                    <button type="submit" name="terminate" value="{{.Id}}" class="btn btn-sm btn-danger">Terminate</button>
      {{end}}
                  </td>
                </tr>
    {{end}}
              </tbody>
            </table>
            </form>
  {{end}}
  {{/*with .Get_missed_payments}}
            <h5 class="text-danger">Missed payments</h5>
            <table class="table table-sm table-danger">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Name</th>
                </tr>
              </thead>
              <tbody>
                <tr>  
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
  {{end*/}}
          </div>
        </section>
        <hr>
{{end}}
        <section>
{{if or (not .Member.Payment) (not .Member.Payment.Get_card)}}
          <h4>Register credit card<img class="ml-3" style="height: 1.5rem" src="/mcvs_acc_hrz.svg"></h4>
          <p class="alert alert-info">This form form allows the online payment service <a href="http://www.beanstream.com/home/">Beanstream</a> to create a payment profile, that we can use to process payments and recurring bills.  No credit card information is stored on or touches our server.<br>
            Credit card registration will not incur a transaction or register you to become a Makerspace member, which must be done below.
          </p>
{{else}}
  {{with .Member.Payment.Get_card}}
          <h4>Update credit card</h4>
          <div class="row px-2 px-sm-3">
            <p class="col-sm-9 mb-2 mb-sm-3 text-muted">
              <strong>Current card:</strong> {{.Number}}<br>
              <strong>Expiry:</strong> {{.ExpiryMonth}}/20{{.ExpiryYear}}
            </p>
            <form action="/member/billing" method="post" class="col-sm-3 mb-3 text-sm-right">
              <button type="submit" name="delete-card" class="btn btn-warning">Delete</button>
            </form>
          </div>
  {{end}}
{{end}}
            <form action="/member/billing" method="post" id="credit-card" class="px-2 px-sm-3">
              <div class="form-group row mb-2 mb-sm-3">
                <label for="name" class="col-sm-4 col-form-label">Name</label>
                <div class="col-sm-8">
                  <input type="text" id="name" name="name" class="form-control" minlength="4" maxlength="32" required{{if or (not .Member.Payment) (not .Member.Payment.Get_card)}} autofocus{{end}}>
                  <small class="form-control-feedback"></small>
                </div>
              </div>
              <div class="form-group row mb-2 mb-sm-3">
                <label for="ccNumber" class="col-sm-4 col-form-label">Card number</label>
              <div class="col-sm-8">
                <div class="input-group" data-beanstream-target="ccNumber_input">
                  <span class="input-group-addon glyphicons glyphicons-credit-card"></span>
                </div>
                                    <small data-beanstream-target="ccNumber_error" class="form-control-feedback"></small>
                                </div>
                            </div>
                            <div class="form-group row mb-2 mb-sm-3">
                                <label for="ccExp" class="col-sm-4 col-form-label">Expiry <span class="font-weight-normal text-muted">(mm/yyyy)</span></label>
                                <div class="col-sm-8">
                                    <div class="input-group" data-beanstream-target="ccExp_input">
                                        <span class="input-group-addon glyphicons glyphicons-calendar"></span>
                                    </div>
                                    <small data-beanstream-target="ccExp_error" class="form-control-feedback"></small>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="ccCvv" class="col-sm-4 col-form-label">CVV</label>
                                <div class="col-sm-8">
                                    <div class="input-group" data-beanstream-target="ccCvv_input">
                                        <span class="input-group-addon glyphicons glyphicons-lock"></span>
                                    </div>
                                    <small data-beanstream-target="ccCvv_error" class="form-control-feedback"></small>
                                </div>
                            </div>
                            <script src="https://payform.beanstream.com/payfields/beanstream_payfields.js" data-submitForm="true"></script>
                            <button type="submit" class="btn btn-primary">
                                {{if or (not .Member.Payment) (not .Member.Payment.Get_card)}}Register{{else}}Update{{end}}
                            </button>
                        </form>
                </section>
                <hr>
                <section>
                    <h4>Membership dues</h4>
                    {{if not .Member.Active}}
                    <p class="alert alert-info">On initial registration, your membership fee gets prorated for the remainder of the current month, and processed immediately.  Following your first payment, successive membership payments will be processed on the 1st of every month.</p>
                    {{end}}
                    <form id="billing" class="px-2 px-sm-3" method="post" action="/member/billing">
                        <fieldset class="form-group mb-2 mb-sm-3">
                            <label class="custom-control custom-radio">
                                <input type="radio" name="rate" class="custom-control-input" value="regular"{{if not .Member.Student}} checked{{end}}>
                                <span class="custom-control-indicator"></span>
                                <span class="custom-control-description"><b>Regular</b> ($50/month)</span>
                            </label>
                            <label class="custom-control custom-radio">
                                <input type="radio" id="student-rate" name="rate" class="custom-control-input" value="student"{{if .Member.Student}} checked{{end}}>
                                <span class="custom-control-indicator"></span>
                                <span class="custom-control-description"><b>Student</b> ($30/month)</span>
                            </label>
                        </fieldset>
                        <fieldset id="student"{{if not .Member.Student}}class="text-muted" disabled{{end}}>
                            <legend class="h5 mb-0 mb-sm-2">Student info</legend>
                            <div class="form-group row mb-2"> 
                                <label for="institution" class="col-sm-4 col-form-label">Institution name</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" id="institution" name="institution" {{if .Member.Student}} value="{{.Member.Student.Institution}}" required{{end}}>
                                    <small class="form-control-feedback"></small>
                                </div>
                            </div>
                            <div class="form-group row mb-2"> 
                                <label for="student_email" class="col-sm-4 col-form-label">Student E-mail</label>
                                <div class="col-sm-8">
                                    <input type="email" class="form-control" name="student_email" {{if .Member.Student}} value="{{.Member.Student.Email}}" required{{end}}>
                                    <small class="form-control-feedback"></small>
                                </div>
                            </div>
                            <div class="form-group row mb-sm-2">
                                <label for="graduation" class="col-sm-4 col-form-label">Expected graduation</label>
                                <div class="col-sm-8">
                                    <input type="month" class="form-control" id="graduation" name="graduation"{{if .Member.Student}} value="{{.Member.Student.Graduation_date.Format "2006-01"}}" required{{end}}>
                                    <small class="form-control-feedback"></small>
                                </div>
                            </div>
                        </fieldset>
                        {{if not .Member.Agreed_to_terms}}
                        <p class="alert alert-danger">You must agree to the <a href="/terms">Terms & Conditions</a>.</p>
                        {{else if or (not .Member.Payment) (not .Member.Payment.Get_card)}}
                        <p class="alert alert-warning">You must register a credit card.</p>
                        {{end}}
                      <div class="d-inline-flex flex-row-reverse">
                        {{if not .Member.Active}}
                        <button type="submit" name="register" class="ml-1 btn btn-primary"{{if or (or (not .Member.Payment) (not .Member.Payment.Get_card)) (not .Member.Agreed_to_terms)}} disabled{{end}}>Register</button>
                        {{end}}
                        <button type="submit" name="update" class="btn btn-secondary">Update</button>
                      </div>
                    </form>
                </section>
            </div>
        </div>
{{template "footer"}}
    </div>
