{{if .Member.Get_membership}}
  <div class="modal fade" id="terminate_membership" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Terminate membership</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form action="/member/billing#terminate_membership" method="post">
          <div class="modal-body">
            <p>Terminating your membership fees will result in immediate revocation of access to makerspace.  Any leased lockers/storage will be cancelled and given to the next member on the waitlist.</p>
            <div class="form-group">
              <textarea class="form-control" name="cancellation_reason" rows="5" placeholder="Is there a reason for your cancellation that you would be willing to share?" autofocus></textarea>
            </div>
          </div>
          <div class="modal-footer align-items-end flex-wrap">
            <div class="mr-auto{{if .Data.password_error}} has-danger{{end}}">
              <label for="password">Please verify your password:</label>
              <div class="form-inline">
                <div class="input-group">
                  <span class="input-group-addon glyphicons glyphicons-fingerprint"></span>
                  <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
                </div>
              </div>
  {{with .Data.password_error}}
              <small class="form-control-feedback show">{{.}}</small>
  {{end}}
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" name="terminate_membership" class="btn btn-danger m-0">Terminate</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
{{end}}
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-7">
        <p class="alert alert-info">
          All prices and transactions are in Canadian dollars.<br>
          Billing inquiries should be addressed to <a href="mailto:accounting@makerspace.ca">accounting@makerspace.ca</a>.
        </p>
        <section>
          <h4>
{{if and .Customer .Customer.DefaultSource}}
            <a href="#cc-form" data-toggle="collapse" aria-expanded="false" class="dropdown-chevron collapsed"></a>
            Update card
            <img class="ml-3 mb-2" style="height: 1.5rem" src="/mcvs_acc_hrz.svg">
          </h4>
          <script src="https://js.stripe.com/v3/"></script>
          <form action="/member/billing" method="post" id="cc-form" class="collapse px-2 px-sm-3">
{{else}}
            Register card
            <img class="ml-3 mb-2" style="height: 1.5rem" src="/mcvs_acc_hrz.svg">
          </h4>
          <script src="https://js.stripe.com/v3/"></script>
          <form action="/member/billing" method="post" id="cc-form" class="collapse show px-2 px-sm-3">
{{end}}
            <div class="row">
              <div class="col-sm-8 form-group">
                <div id="card-element"></div>
                <div class="text-danger" id="card-errors"></div>
              </div>
              <div class="col-sm-4">
                <button type="submit" class="btn btn-primary">Register card</button>
              </div>
            </div>
          </form>
          <script>
            var stripe = Stripe("{{.Config.Billing.Public_key}}");
            var elements = stripe.elements();
            var style = {
              base: {
                color: '#464a4c',
                lineHeight: '20px',
                fontSize: '16px',
                '::placeholder': {
                  color: '#aab7c4'
                }
              },
              invalid: {
                color: '#fa755a',
                iconColor: '#fa755a'
              }
            };
            var card = elements.create("card", {style: style});
            card.mount("#card-element");
            card.addEventListener("change", function(event) {
              var displayError = document.getElementById("card-errors");
              if (event.error) {
                displayError.textContent = event.error.message;
              } else {
                displayError.textContent = "";
              }
            });
            var form = document.getElementById("cc-form");
            form.addEventListener("submit", function(event) {
              event.preventDefault();
              stripe.createToken(card).then(function(result) {
                if (result.error) {
                  var errorElement = document.getElementById('card-errors');
                  errorElement.textContent = result.error.message;
                } else {
                  stripeTokenHandler(result.token);
                }
              });
            });
            function stripeTokenHandler(token) {
              var form = document.getElementById("cc-form");
              var hiddenInput = document.createElement("input");
              hiddenInput.setAttribute("type", "hidden");
              hiddenInput.setAttribute('name', 'stripeToken');
              hiddenInput.setAttribute('value', token.id);
              form.appendChild(hiddenInput);
              form.submit();
            }
          </script>
        </section>
        <hr>
        <section>
{{if .Get_membership}}
          <h4>
            <a href="#membership-registration" data-toggle="collapse" aria-expanded="false" class="dropdown-chevron collapsed"></a>
            Update Membership
          </h4>
          <form id="membership-registration" class="collapse px-2 px-sm-3" method="post" action="/member/billing">
{{else}}
          <h4>
            <a href="#membership-registration" data-toggle="collapse" aria-expanded="true" class="dropdown-chevron"></a>
            Membership registration
          </h4>
          <form id="membership-registration" class="collapse show px-2 px-sm-3" method="post" action="/member/billing">
{{end}}
{{if .Member.Get_pending_membership}}
            <p class="alert alert-success">Your membership request is pending approval.</p>
{{end}}
            <fieldset class="form-group mb-2 mb-sm-3">
              <label class="custom-control custom-radio">
                <input type="radio" name="rate" class="custom-control-input" value="regular"{{if not .Member.Student}} checked{{end}}>
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description"><b>Regular</b> ($50/month)</span>
              </label>
              <label class="custom-control custom-radio">
                <input type="radio" id="student-rate" name="rate" class="custom-control-input" value="student"{{if .Member.Student}} checked{{end}}>
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description"><b>Student</b> ($30/month)</span>
              </label>
            </fieldset>
            <fieldset id="student"{{if not .Member.Student}}class="text-muted" disabled{{end}}>
              <legend class="h5 mb-0 mb-sm-2">Student info</legend>
              <div class="form-group row mb-2"> 
                <label for="institution" class="col-sm-4 col-form-label">Institution name</label>
                <div class="col-sm-8">
                  <input type="text" class="form-control" id="institution" name="institution" {{if .Member.Student}} value="{{.Member.Student.Institution}}" required{{end}}>
                </div>
              </div>
              <div class="form-group row mb-2"> 
                <label for="student_email" class="col-sm-4 col-form-label">Student E-mail</label>
                <div class="col-sm-8">
                  <input type="email" class="form-control" name="student_email" {{if .Member.Student}} value="{{.Member.Student.Email}}" required{{end}}>
                </div>
              </div>
              <div class="form-group row mb-sm-2">
                <label for="graduation" class="col-sm-4 col-form-label">Expected graduation</label>
                <div class="col-sm-8">
                  <input type="month" class="form-control" id="graduation" name="graduation"{{if .Member.Student}} value="{{.Member.Student.Graduation_date.Format "2006-01"}}" required{{end}}>
                </div>
              </div>
            </fieldset>
{{with .Data.membership_registration_error}}
            <p class="text-danger">{{.}}</p>
{{end}}
{{if not .Member.Agreed_to_terms}}
          <p class="alert alert-danger">You must agree to the <a href="/terms">Terms & Conditions</a>.</p>
{{end}}
          <div class="d-inline-flex flex-row-reverse">
            <input type="hidden" name="membership">
{{if not .Get_membership}}
{{if and .Customer .Customer.DefaultSource}}
              <button type="submit" name="register" class="ml-1 btn btn-primary"{{if not .Member.Agreed_to_terms}} disabled{{end}}>Register</button>
  {{else}}
              <button type="submit" name="register" class="ml-1 btn btn-primary"disabled>Register</button>
  {{end}}
{{end}}
              <button type="submit" name="update" class="btn btn-secondary">Update</button>
            </div>
          </form>
        </section>
      </div>
    </div>
  </div>
