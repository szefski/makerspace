{{$ms := .Get_membership}}
{{if $ms}}
  <div class="modal fade" id="cancel-membership" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cancel membership</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form action="/member/billing#cancel-membership" method="post">
          <div class="modal-body">
            <p>Cancelling your membership will result in immediate revocation of access to makerspace.</p>
            <div class="form-group">
              <textarea class="form-control" name="cancellation-reason" rows="5" placeholder="Is there a reason for your cancellation that you would be willing to share?" autofocus></textarea>
            </div>
          </div>
          <div class="modal-footer align-items-end flex-wrap">
            <div class="mr-auto{{if .Data.password_error}} has-danger{{end}}">
              <label for="password">Please verify your password:</label>
              <div class="form-inline">
                <div class="input-group">
                  <span class="input-group-addon glyphicons glyphicons-fingerprint"></span>
                  <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
                </div>
              </div>
  {{with .Data.password_error}}
              <small class="form-control-feedback show">{{.}}</small>
  {{end}}
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" name="cancel-membership" value="{{$ms.ID}}" class="btn btn-danger m-0">Cancel</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
{{end}}
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10 col-xl-8">
        <p class="alert alert-info">
          All prices and transactions are in Canadian dollars.<br>
          Billing inquiries should be addressed to <a href="mailto:accounting@makerspace.ca">accounting@makerspace.ca</a>.
        </p>
{{with .Active_subscriptions}}
        <section id="Subscriptions">
          <h4>Subscriptions</h4>
          <form action="/member/billing" method="post" class="mx-sm-3">
            <table class="table table-sm table-striped table-responsive text-nowrap">
              <thead>
                <tr>
                  <th class="w-100">Name</th>
                  <th>Amount</th>
                  <th>Current period</th>
                  <th>Created</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
  {{range .}}
                <tr{{if eq .ID $.Membership_id}} class="table-active"{{end}}>
                  <td>{{.Plan.Name}}</td>
                  <td>{{fmt_money (mul .Quantity .Plan.Amount)}}</td>
                  <td>
                    {{(timestamp .PeriodStart).Format "Jan 02"}}
                    &ndash;
                    {{(timestamp .PeriodEnd).Format "Jan 02"}}
                  </td>
                  <td>{{(timestamp .Created).Format "02/01/2006"}}</td>
                  <td>
    {{if eq .ID $.Membership_id}}
                    <button type="button" data-toggle="modal" data-target="#cancel-membership" class="btn btn-sm btn-danger">Cancel</button>
    {{else}}
                    <button type="submit" name="cancel-subscription" value="{{.ID}}" class="btn btn-sm btn-danger">Cancel</button>
    {{end}}
                  </td>
                </tr>
  {{end}}
              </tbody>
            </table>
          </form>
        </section>
{{end}}
        <section>
          <h4>
{{if .Has_card}}
            <a href="#cc-form" data-toggle="collapse" aria-expanded="false" class="dropdown-chevron collapsed"></a>
            Update card
            <img class="ml-3 mb-2" style="height: 1.5rem" src="/mcvs_acc_hrz.svg">
          </h4>
          <script src="https://js.stripe.com/v3/"></script>
          <form action="/member/billing" method="post" id="cc-form" class="collapse px-2 px-sm-3">
{{else}}
            Register card
            <img class="ml-3 mb-2" style="height: 1.5rem" src="/mcvs_acc_hrz.svg">
          </h4>
          <script src="https://js.stripe.com/v3/"></script>
          <form action="/member/billing" method="post" id="cc-form" class="collapse show px-2 px-sm-3">
{{end}}
            <div class="row">
              <div class="col-sm-8 form-group">
                <div id="card-element"></div>
                <div class="text-danger" id="card-errors">{{.Data.card_error}}</div>
              </div>
              <div class="col-sm-4">
                <button type="submit" class="btn btn-primary">Register card</button>
              </div>
            </div>
          </form>
          <script>
            var stripe = Stripe("{{.Config.Billing.Public_key}}");
            var elements = stripe.elements();
            var style = {
              base: {
                color: '#464a4c',
                lineHeight: '20px',
                fontSize: '16px',
                '::placeholder': {
                  color: '#aab7c4'
                }
              },
              invalid: {
                color: '#fa755a',
                iconColor: '#fa755a'
              }
            };
            var card = elements.create("card", {style: style});
            card.mount("#card-element");
            card.addEventListener("change", function(event) {
              var displayError = document.getElementById("card-errors");
              if (event.error) {
                displayError.textContent = event.error.message;
              } else {
                displayError.textContent = "";
              }
            });
            var form = document.getElementById("cc-form");
            form.addEventListener("submit", function(event) {
              event.preventDefault();
              stripe.createToken(card).then(function(result) {
                if (result.error) {
                  var errorElement = document.getElementById('card-errors');
                  errorElement.textContent = result.error.message;
                } else {
                  stripeTokenHandler(result.token);
                }
              });
            });
            function stripeTokenHandler(token) {
              var form = document.getElementById("cc-form");
              var hiddenInput = document.createElement("input");
              hiddenInput.setAttribute("type", "hidden");
              hiddenInput.setAttribute('name', 'stripeToken');
              hiddenInput.setAttribute('value', token.id);
              form.appendChild(hiddenInput);
              form.submit();
            }
          </script>
        </section>
        <hr>
        <section>
          <h4>
{{if or (not $ms) (or .Data.membership_registration_error .Get_pending_membership)}}
            <a href="#membership-registration" data-toggle="collapse" aria-expanded="true" class="dropdown-chevron"></a>
{{else}}
            <a href="#membership-registration" data-toggle="collapse" aria-expanded="false" class="dropdown-chevron collapsed"></a>
{{end}}
{{if $ms}}
            Update Membership
{{else}}
            Membership registration
{{end}}
          </h4>
{{if or (not $ms) (or .Data.membership_registration_error .Get_pending_membership)}}
          <form id="membership-registration" class="collapse show px-2 px-sm-3" method="post" action="/member/billing">
{{else}}
          <form id="membership-registration" class="collapse px-2 px-sm-3" method="post" action="/member/billing">
{{end}}
{{with .Member.Get_pending_membership}}
            <p class="alert alert-success">
              Your request for "{{with index $.Plans .Plan_id}}{{.Name}}{{end}}" is pending approval.
              <button type="submit" class="btn btn-sm btn-danger" name="cancel-pending-membership">Cancel</button>
            </p>
{{else}}
  {{if not $ms}}
            <p>
              Before you can become a member, you should attend an open-house.  Open-house nights are on the 2nd and 4th Tuesday of each month, from 7 to 9pm.
            </p>
  {{end}}
{{end}}
            <fieldset class="mb-1"{{if or (not .Member.Agreed_to_terms) (not .Has_card)}} disabled{{end}}>
              <label class="custom-control custom-radio">
{{with $ms}}
                <input type="radio" name="rate" class="custom-control-input" value="membership-regular"{{if eq .Plan.ID "membership-regular"}} checked{{end}}>
{{else}}
                <input type="radio" name="rate" class="custom-control-input" value="membership-regular"{{if not .Member.Student}} checked{{end}}>
{{end}}
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description"><b>Regular</b> ($50/month)</span>
              </label>
              <label class="custom-control custom-radio">
{{with $ms}}
                <input type="radio" id="student-rate" name="rate" class="custom-control-input" value="membership-student"{{if eq .Plan.ID "membership-student"}} checked{{end}}>
{{else}}
                <input type="radio" id="student-rate" name="rate" class="custom-control-input" value="membership-student"{{if .Member.Student}} checked{{end}}>
{{end}}
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description"><b>Student</b> ($30/month)</span>
              </label>
{{with $ms}}
  {{if eq .Plan.ID "membership-free"}}
              <label class="custom-control custom-radio">
                <input type="radio" class="custom-control-input" name="rate" checked>
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description"><b>Free</b></span>
              </label>
  {{end}}
{{end}}
            </fieldset>
{{if $ms}}
  {{if eq $ms.Plan.ID "membership-student"}}
            <fieldset id="student" class="mt-2 collapse show">
  {{else}}
            <fieldset id="student" class="mt-2 collapse">
  {{end}}
{{else if .Member.Student}}
            <fieldset id="student" class="mt-2 collapse show">
{{else}}
            <fieldset id="student" class="mt-2 collapse">
{{end}}
              <legend class="h5 mb-0 mb-sm-2">Student info</legend>
              <div class="form-group row mb-2"> 
                <label for="institution" class="col-sm-4 col-form-label">Institution name</label>
                <div class="col-sm-8">
                  <input type="text" class="form-control" name="institution" {{if .Member.Student}} value="{{.Member.Student.Institution}}"{{end}} required>
                </div>
              </div>
              <div class="form-group row mb-2"> 
                <label for="student-email" class="col-sm-4 col-form-label">Student E-mail</label>
                <div class="col-sm-8">
                  <input type="email" class="form-control" name="student-email" {{if .Member.Student}} value="{{.Member.Student.Email}}"{{end}} required>
                </div>
              </div>
              <div class="form-group row mb-sm-2">
                <label for="graduation-date" class="col-sm-4 col-form-label">Expected graduation</label>
                <div class="col-sm-8">
                  <input type="month" class="form-control" name="graduation-date"{{if .Member.Student}} value="{{.Member.Student.Graduation_date.Format "2006-01"}}"{{end}} required>
                </div>
              </div>
            </fieldset>
            <div class="d-inline-flex mt-2">
{{if $ms}}
              <button type="submit" name="register-membership" class="btn btn-primary"{{if not .Has_card}} disabled{{end}}>Update</button>
              <button type="button" data-toggle="modal" data-target="#cancel-membership" class="ml-1 btn btn-danger">Cancel</button>
{{else}}
              <button type="submit" name="register-membership" class="btn btn-primary"{{if or (not .Member.Agreed_to_terms) (not .Has_card)}} disabled{{end}}>Register</button>
{{end}}
{{if not .Member.Agreed_to_terms}}
              <p class="alert alert-warning ml-3 mb-0 py-2">
                You must agree to the <a href="/terms">Terms & Conditions</a> before requesting a membership.
              </p>
{{else if not .Has_card}}
              <p class="alert alert-warning ml-3 mb-0 py-2">You must register a credit card before membership registration.</p>
{{end}}
{{with .Data.membership_registration_error}}
              <p class="alert alert-danger ml-3 mb-0 py-2">{{.}}.</p>
{{end}}
            </div>
          </form>
        </section>
      </div>
    </div>
  </div>
