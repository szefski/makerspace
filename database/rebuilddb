#!/usr/bin/env bash

psql makerspace <<EOF

DROP TABLE IF EXISTS member CASCADE;
DROP TABLE IF EXISTS session_http CASCADE;
DROP TABLE IF EXISTS administrator CASCADE;
DROP TABLE IF EXISTS student CASCADE;
DROP TABLE IF EXISTS billing_profile CASCADE;
DROP TABLE IF EXISTS transaction CASCADE;
DROP TABLE IF EXISTS billing CASCADE;
DROP TABLE IF EXISTS storage CASCADE;

CREATE TABLE member (
    username text PRIMARY KEY,
    name text NOT NULL,
    password_key character(64) NOT NULL,
    password_salt character(64) NOT NULL UNIQUE,
    email text NOT NULL UNIQUE,
    email_validated boolean NOT NULL DEFAULT false,
    active boolean NOT NULL DEFAULT false,
    registered timestamp(0) DEFAULT now()
);
CREATE TABLE session_http (
    token character(64) PRIMARY KEY,
    username text NOT NULL REFERENCES member,
    sign_in_time timestamp(0) NOT NULL DEFAULT now(),
    last_seen timestamp(0) NOT NULL DEFAULT now(),
    expires timestamp(0)
);
CREATE TABLE administrator (
    username text PRIMARY KEY REFERENCES member
);
CREATE TABLE student (
    username text PRIMARY KEY REFERENCES member,
    institution text,
    graduation_date date
);
CREATE TABLE billing_profile (
    username text PRIMARY KEY REFERENCES member,
    id text UNIQUE NOT NULL
);
CREATE TABLE billing (
    id serial PRIMARY KEY,
    username text NOT NULL REFERENCES member,
    amount money NOT NULL,
    description text,
    registered date NOT NULL DEFAULT now(),
    monthly boolean NOT NULL DEFAULT true,
    start_date date NOT NULL,
    end_date date
);
CREATE TABLE transaction (
    id integer PRIMARY KEY,
    username text NOT NULL REFERENCES member,
    approved boolean NOT NULL,
    order_id text NOT NULL,
    amount money NOT NULL,
    name text,
    card character(4),
    ip_address text,
    billing integer REFERENCES billing,
    time timestamp(0) NOT NULL DEFAULT now()
);
CREATE TABLE storage (
    location text NOT NULL,
    number integer NOT NULL,
    member text REFERENCES member,
    description text,
    PRIMARY KEY (location, number)
);

EOF

psql makerspace < ./data.sql
