#!/usr/bin/env bash

psql makerspace <<EOF

DROP TABLE IF EXISTS member CASCADE;
DROP TABLE IF EXISTS email CASCADE;
DROP TABLE IF EXISTS storage CASCADE;

CREATE TABLE member (
    username text PRIMARY KEY,
    name text NOT NULL,
    password_key character(32) NOT NULL,
    password_salt character(32) NOT NULL UNIQUE
);
CREATE TABLE session_http (
    key text PRIMARY KEY,
    username text NOT NULL REFERENCES member,
    sign_in_time timestamp NOT NULL,
    last_seen timestamp NOT NULL
);
CREATE TABLE email (
    address text PRIMARY KEY,
    member text NOT NULL REFERENCES member,
    "primary" boolean DEFAULT true NOT NULL,
    validated boolean DEFAULT false NOT NULL
);
CREATE TABLE storage (
    location text NOT NULL,
    number integer NOT NULL,
    member text REFERENCES member,
    description text,
    PRIMARY KEY (location, number)
);
CREATE UNIQUE INDEX ON email (member, "primary") WHERE ("primary" = true);

EOF
